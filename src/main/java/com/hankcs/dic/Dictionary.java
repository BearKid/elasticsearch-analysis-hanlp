package com.hankcs.dic;

import com.hankcs.cfg.Configuration;
import com.hankcs.dic.cache.DictionaryFileCache;
import com.hankcs.dic.config.RemoteDictConfig;
import com.hankcs.hanlp.utility.Predefine;
import com.hankcs.help.ESPluginLoggerFactory;
import org.apache.logging.log4j.Logger;
import org.elasticsearch.plugin.analysis.hanlp.AnalysisHanLPPlugin;

import java.nio.file.Path;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

/**
 * @project: elasticsearch-analysis-hanlp
 * @description: 词典类
 * @author: Kenn
 * @create: 2018-12-14 15:10
 */
public class Dictionary {
    /**
     * 词典单子实例
     */
    private static Dictionary singleton;
    /**
     * Hanlp配置文件名
     */
    private static final String CONFIG_FILE_NAME = "hanlp.properties";
    /**
     * Hanlp远程词典配置文件名
     */
    private static final String REMOTE_CONFIG_FILE_NAME = "hanlp-remote.xml";

    private static final Logger logger = ESPluginLoggerFactory.getLogger(Dictionary.class.getName());

    private static ScheduledExecutorService pool = Executors.newScheduledThreadPool(1);

    private Dictionary(Configuration configuration) {
        Path configDir = configuration.getEnvironment().configFile().resolve(AnalysisHanLPPlugin.PLUGIN_NAME);
        Predefine.HANLP_PROPERTIES_PATH = configDir.resolve(CONFIG_FILE_NAME).toString();
        logger.debug("hanlp properties path: {}", Predefine.HANLP_PROPERTIES_PATH);
        DictionaryFileCache.configCachePath(configuration);
        DictionaryFileCache.loadCache();
        RemoteDictConfig.initial(configDir.resolve(REMOTE_CONFIG_FILE_NAME).toString());
    }

    public static synchronized Dictionary initial(Configuration configuration) {
        if (singleton == null) {
            synchronized (Dictionary.class) {
                if (singleton == null) {
                    singleton = new Dictionary(configuration);
                    pool.scheduleAtFixedRate(new ExtMonitor(), 10, 60, TimeUnit.SECONDS);
                    if (configuration.isEnableRemoteDict()) {
                        final String reportFetchStatusURL = RemoteDictConfig.getSingleton().getReportFetchStatusURL();
                        for (String location : RemoteDictConfig.getSingleton().getRemoteExtDictionarys()) {
                            pool.scheduleAtFixedRate(
                                new RemoteMonitor(location, RemoteMonitor.DicCategory.MAIN, reportFetchStatusURL),
                                10, 60, TimeUnit.SECONDS
                            );
                        }

                        for (String location : RemoteDictConfig.getSingleton().getRemoteExtStopWordDictionarys()) {
                            pool.scheduleAtFixedRate(
                                new RemoteMonitor(location, RemoteMonitor.DicCategory.STOP_WORD, reportFetchStatusURL),
                                10, 60, TimeUnit.SECONDS
                            );
                        }
                    }
                    return singleton;
                }
            }
        }
        return singleton;
    }
}
